name: Create Release PR

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  skip-if-released:
    runs-on: ubuntu-latest
    outputs:
      skip_release_pr: ${{ steps.check-release-commit.outputs.skip_release_pr }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Skip if the release commit is merged
        id: check-release-commit
        run: |
          latest_commit_message=$(git log -1 --pretty=%B)
          if echo "$latest_commit_message" | grep -q "chore: release v"; then
            echo "skip_release_pr=true" >> $GITHUB_OUTPUT
          else
            echo "skip_release_pr=false" >> $GITHUB_OUTPUT
          fi

  create-release-pr:
    runs-on: ubuntu-latest
    needs: skip-if-released
    if: needs.skip-if-released.outputs.skip_release_pr == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Ensure scripts executable
        run: chmod +x .github/scripts/*.js || true

      - name: Install GitHub CLI
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Fetch all tags
        run: git fetch --tags

      - name: Get latest semver tag
        id: latest-tag
        run: |
          latest_tag=$(git tag -l | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          if [ -z "$latest_tag" ]; then
            latest_tag="0.0.0"
          fi
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT

      - name: Get merged PRs since latest tag
        id: get-prs
        env:
          GH_TOKEN: ${{ github.token }}
          LATEST_TAG: ${{ steps.latest-tag.outputs.latest_tag }}
        run: |
          if [ "$LATEST_TAG" = "0.0.0" ]; then
            base_sha=$(git rev-list --max-parents=0 HEAD)
          else
            base_sha=$(git rev-list -n 1 "$LATEST_TAG")
          fi
          commits=$(git rev-list ${base_sha}..HEAD)
          excluded_labels="skip-changelog,duplicate,invalid"
          all_labels=""
          for commit_sha in $commits; do
            pr_number=$(gh pr list --search "$commit_sha" --state merged --json number --jq '.[0].number' || echo "")
            if [ -n "$pr_number" ]; then
              pr_labels=$(gh pr view "$pr_number" --json labels --jq '.labels[].name' | tr '\n' ',' || echo "")
              if [ -n "$pr_labels" ]; then
                all_labels="${all_labels}${pr_labels}"
              fi
            fi
          done
          filtered_labels=$(echo "$all_labels" | tr ',' '\n' | grep -v -E "^(${excluded_labels})$" | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "labels=$filtered_labels" >> $GITHUB_OUTPUT

      - name: Compute next version
        id: compute
        env:
          LATEST_TAG: ${{ steps.latest-tag.outputs.latest_tag }}
          LABELS: ${{ steps.get-prs.outputs.labels }}
        run: |
          result=$(node .github/scripts/compute-next-version.js "$LATEST_TAG" "$LABELS")
          next_tag=$(echo "$result" | jq -r '.nextTag')
          bump_type=$(echo "$result" | jq -r '.bumpType')
          echo "next_tag=$next_tag" >> $GITHUB_OUTPUT
          echo "bump_type=$bump_type" >> $GITHUB_OUTPUT

      - name: Create draft release
        env:
          GH_TOKEN: ${{ github.token }}
          NEXT_TAG: ${{ steps.compute.outputs.next_tag }}
          LATEST_TAG: ${{ steps.latest-tag.outputs.latest_tag }}
        run: |
          existing_draft=$(gh release list --exclude-pre-releases | grep "Release $NEXT_TAG" | grep "Draft" || echo "")
          if [ -n "$existing_draft" ]; then
            gh release delete "$NEXT_TAG" --yes
          fi
          gh release create "$NEXT_TAG" \
            --title "Release $NEXT_TAG" \
            --draft \
            --generate-notes \
            --notes-start-tag "$LATEST_TAG"

      - name: Create or update release PR
        env:
          GH_TOKEN: ${{ github.token }}
          NEXT_TAG: ${{ steps.compute.outputs.next_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          release_notes=$(gh release view "$NEXT_TAG" --json body --jq '.body')
          node .github/scripts/create-or-update-pr.js "$NEXT_TAG" "$release_notes"