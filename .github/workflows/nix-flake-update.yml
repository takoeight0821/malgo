name: nix-flake-update

on:
  schedule:
    - cron: "0 3 * * 1" # Weekly Monday 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # V31
      - name: Update flake.lock
        shell: bash
        run: nix flake update

      - name: Create PR with updated flake.lock
        uses: ./.github/actions/create-update-pr
        with:
          branch-name: automation/nix-flake-update
          commit-message: "chore(deps): update flake.lock"
          pr-title: "chore(deps): update flake.lock"
          pr-body: |
            Automated weekly update of flake.lock via GitHub Actions.
            
            - Ran `nix flake update`
            - CI will validate builds and checks
          labels: "dependencies,nix"
          files: flake.lock
          github-token: ${{ github.token }}
