name: nix-flake-update

on:
  schedule:
    - cron: "0 3 * * 1" # Weekly Monday 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix (non-interactive)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://nixos.org/nix/install -o /tmp/install-nix.sh
          sh /tmp/install-nix.sh --no-daemon
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
          nix --version

      - name: Update flake.lock
        shell: bash
        run: |
          set -euo pipefail
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
          nix flake update

      - name: Create PR with updated flake.lock
        uses: ./.github/actions/create-update-pr
        with:
          branch-name: automation/nix-flake-update
          commit-message: "chore(nix): update flake.lock"
          pr-title: "chore(nix): update flake.lock"
          pr-body: |
            Automated weekly update of flake.lock via GitHub Actions.
            
            - Ran `nix flake update`
            - CI will validate builds and checks
          labels: "dependencies,nix"
          files: flake.lock
          github-token: ${{ github.token }}
